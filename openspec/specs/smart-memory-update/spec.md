# 智能记忆更新功能规范

## 功能概述

本规范定义了 nanobot 智能记忆更新功能的需求。该功能基于每日对话概要，智能评估和更新长期记忆文件。

## ADDED Requirements（新增需求）

---

### Requirement: 重要性评分

系统 SHALL 对提取的信息进行重要性评分，决定是否记录到长期记忆。

#### Scenario: 用户明确要求

- **WHEN** 用户使用"记住"、"记录"、"请记住"等明确指令
- **THEN** 该信息获得最高优先级（3 分）
- **AND** 直接记录到长期记忆

#### Scenario: 配置信息

- **WHEN** 信息包含 API 密钥、模型名称、系统配置等内容
- **THEN** 该信息获得高优先级（2 分）
- **AND** 记录到长期记忆的配置部分

#### Scenario: 用户偏好

- **WHEN** 信息描述用户的喜好、风格、习惯等
- **THEN** 该信息获得中优先级（1 分）
- **AND** 记录到长期记忆的用户偏好部分

#### Scenario: 技术问题

- **WHEN** 信息包含问题描述和解决方案
- **THEN** 该信息获得高优先级（2 分）
- **AND** 记录到长期记忆的技术问题部分

---

### Requirement: 去重机制

系统 SHALL 避免在长期记忆中记录重复信息。

#### Scenario: 完全匹配

- **WHEN** 新信息与现有记忆完全相同
- **THEN** 跳过该信息
- **AND** 不记录到长期记忆

#### Scenario: 相似内容

- **WHEN** 新信息与现有记忆相似度高于 80%（编辑距离）
- **THEN** 视为重复，跳过记录
- **AND** 可通过配置调整相似度阈值

#### Scenario: 阈值配置

- **WHEN** 需要调整去重敏感度
- **THEN** 支持通过环境变量配置相似度阈值
- **AND** 默认阈值为 80%

---

### Requirement: 分类存储

系统 SHALL 将长期记忆信息分类存储，便于管理和检索。

#### Scenario: 结构化存储

- **WHEN** 更新长期记忆
- **THEN** 使用清晰的分类标记
- **AND** 每个分类包含相关的内容列表

#### Scenario: 分类标准

- **WHEN** 定义记忆分类
- **THEN** 使用以下标准分类：
  1. 用户信息：姓名、联系方式、角色等
  2. 偏好设置：模型、风格、语言等
  3. 技术配置：API 密钥、系统设置等
  4. 重要决定：技术选择、架构决策等
  5. 技术问题：已解决的问题和解决方案

---

### Requirement: 去重算法

系统 SHALL 使用简单但有效的算法进行去重判断。

#### Scenario: 字符串相似度

- **WHEN** 评估两个字符串的相似度
- **THEN** 使用编辑距离（Levenshtein Distance）算法
- **AND** 计算相似度百分比

#### Scenario: 算法优化

- **WHEN** 处理大量记忆条目
- **THEN** 限制每次比对的范围
- **AND** 使用快速跳过机制（完全匹配直接跳过）

---

### Requirement: 更新策略

系统 SHALL 采用安全的长期记忆更新策略。

#### Scenario: 追加而非覆盖

- **WHEN** 更新长期记忆
- **THEN** 使用追加模式添加新内容
- **AND** 不删除或覆盖现有记忆

#### Scenario: 备份机制

- **WHEN** 更新长期记忆
- **THEN** 自动创建备份文件
- **AND** 保留最近的 N 个备份（默认 5 个）

---

### Requirement: 记忆限制

系统 SHALL 支持限制长期记忆的条目数量。

#### Scenario: 最大条目数

- **WHEN** 长期记忆超过配置的最大条目数
- **THEN** 删除最早的条目
- **AND** 保持最新的记录

#### Scenario: 配置化限制

- **WHEN** 需要调整记忆限制
- **THEN** 支持通过配置文件设置最大条目数
- **AND** 默认值为 100 条

---

### Requirement: 错误处理

系统 SHALL 妥善处理记忆更新过程中的错误。

#### Scenario: 文件读写失败

- **WHEN** 无法读取或写入长期记忆文件
- **THEN** 记录详细错误日志
- **AND** 不影响主对话功能
- **AND** 提供友好的错误消息（如果可显示）

#### Scenario: 格式错误

- **WHEN** 长期记忆文件格式损坏
- **THEN** 尝试恢复或重建
- **AND** 保留尽可能多的内容

---

### Requirement: 日志记录

系统 SHALL 记录记忆更新的关键操作。

#### Scenario: 成功更新

- **WHEN** 成功更新长期记忆
- **THEN** 记录更新类型和内容概要
- **AND** 日志级别为 INFO

#### Scenario: 跳过重复

- **WHEN** 检测到重复信息
- **THEN** 记录跳过原因
- **AND** 日志级别为 DEBUG

#### Scenario: 错误情况

- **WHEN** 遇到更新失败或异常
- **THEN** 记录完整的错误堆栈
- **AND** 日志级别为 ERROR
